---
title: "LDATS on a dataset that likes lots of topics"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(LDATS)
library(MATSS)
library(dplyr)
library(ggplot2)
```

```{r load community data}

datasets <- build_bbs_datasets_plan()

m <- which(grepl(datasets$target, pattern = "rtrg_1_11")) # wants many topics

dat <- eval(unlist(datasets$command[m][[1]]))

```

This community has a total of `r ncol(dat$abundance)` species surveyed in `r nrow(dat$abundance)` years from `r min(dat$covariates$year)` to `r max(dat$covariates$year)`.

```{r plot dat}

dat_long <- dat$abundance %>%
  mutate(year = dat$covariates$year,
         totalannual = rowSums(dat$abundance))  %>%
  tidyr::pivot_longer(c(-year, -totalannual),names_to = "species", values_to = "abundance") %>%
  mutate(propannual = abundance / totalannual)


ggplot(dat_long, aes(year, propannual, color = species)) +
  geom_line() +
  theme_bw() +
  scale_color_viridis_d() +
  theme(legend.position = "none") +
  ggtitle("Proportional abundance of all species")
```

First let's fit an LDA + TS as we might have once upon a time.

```{r LDATS on dat}
# takes forever to run
 dat_LDAs <- LDA_set(dat$abundance, topics = c(2:20, c(23, 30, 40, 50, 70)), nseeds = 20)

dat_LDAs <- readRDS(here::here("dat_ldas.Rds"))


```
